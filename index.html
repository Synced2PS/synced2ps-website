<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synced2PS | Book Your Strategy Call | Apple Gift Card Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* All CSS remains the same as before - unchanged */
        /* [PASTE YOUR ENTIRE EXISTING CSS HERE] */
        /* It's exactly the same as your current CSS */
    </style>
</head>
<body>
    <!-- Your entire HTML structure remains the same -->
    <!-- [PASTE YOUR ENTIRE EXISTING HTML STRUCTURE HERE] -->
    <!-- From <header> to <footer> - all sections remain identical -->
    
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
    
    <!-- Firebase Config -->
    <script src="js/firebase-config.js"></script>
    
    <!-- Auth Manager -->
    <script src="js/auth.js"></script>
    
    <script>
        // ==================== REAL-TIME SYNC VARIABLES ====================
        let selectedPlan = '';
        let selectedPlanPrice = 0;
        let currentStep = 1;
        let contactMethod = 'phone';
        let timeDropdownOpen = false;
        
        // REAL-TIME BOOKED SLOTS - Shared across all users
        let realTimeBookedSlots = {};
        let unsubscribeFromSlots = null;
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üöÄ Website loaded - initializing real-time sync...");
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('call-date');
            if (dateInput) {
                dateInput.min = today;
                dateInput.value = today;
            }
            
            // Set current year in footer
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // Initialize all components
            initializeAll();
            
            // Setup admin access (hidden)
            setupHiddenAdminAccess();
        });
        
        // ==================== REAL-TIME FIREBASE SYNC ====================
        async function initializeRealtimeSync() {
            try {
                // Subscribe to booked slots updates
                unsubscribeFromSlots = db.collection('bookedSlots')
                    .onSnapshot((snapshot) => {
                        console.log("üîÑ Received real-time update for booked slots");
                        realTimeBookedSlots = {};
                        
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            realTimeBookedSlots[data.timeKey] = true;
                        });
                        
                        // Refresh time slots display
                        generateTimeSlots();
                    }, (error) => {
                        console.error("Error listening to slots:", error);
                    });
                
                console.log("‚úÖ Real-time sync initialized");
                
            } catch (error) {
                console.error("‚ùå Failed to initialize real-time sync:", error);
            }
        }
        
        // ==================== FIXED TIME SLOT GENERATION WITH REAL-TIME SYNC ====================
        function generateTimeSlots() {
            const dateInput = document.getElementById('call-date');
            if (!dateInput) return;
            
            const selectedDate = dateInput.value;
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const currentHour = now.getUTCHours();
            const currentMinute = now.getMinutes();
            
            const timeDropdown = document.getElementById('timeSelectDropdown');
            const times = [];
            
            const isToday = selectedDate === today;
            
            // Generate time slots from 9 AM to 8:30 PM GMT
            for (let hour = 9; hour <= 20; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    if (hour === 20 && minute === 30) break;
                    
                    const slotHour = hour;
                    const slotMinute = minute;
                    
                    // Skip past times for today
                    if (isToday) {
                        const nowInMinutes = currentHour * 60 + currentMinute;
                        const slotInMinutes = slotHour * 60 + slotMinute;
                        const timeDifference = slotInMinutes - nowInMinutes;
                        
                        if (timeDifference < 120) { // Less than 2 hours from now
                            continue;
                        }
                    }
                    
                    const ampm = hour >= 12 ? 'PM' : 'AM';
                    const displayHour = hour % 12 || 12;
                    const displayMinute = minute === 0 ? '00' : '30';
                    
                    const timeString = `${displayHour}:${displayMinute} ${ampm}`;
                    const timeKey = `${selectedDate}_${hour}:${minute === 0 ? '00' : '30'}`;
                    
                    // Check if slot is booked in real-time data
                    const isBooked = realTimeBookedSlots[timeKey] === true;
                    
                    times.push({
                        display: timeString,
                        key: timeKey,
                        hour: hour,
                        minute: minute,
                        booked: isBooked
                    });
                }
            }
            
            // Generate HTML for time slots
            if (timeDropdown) {
                timeDropdown.innerHTML = times.map(time => 
                    `<div class="time-option ${time.booked ? 'booked' : ''}" 
                          onclick="${time.booked ? '' : `selectTime('${time.display}', '${time.key}')`}"
                          ${time.booked ? 'style="cursor: not-allowed;"' : ''}>
                        ${time.display} ${time.booked ? '(Booked)' : ''}
                    </div>`
                ).join('');
                
                // Reset selection if current time is booked
                const selectedTimeKey = document.getElementById('selected-time')?.dataset?.key;
                if (selectedTimeKey) {
                    const selectedTime = times.find(t => t.key === selectedTimeKey);
                    if (!selectedTime || selectedTime.booked) {
                        document.getElementById('selectedTimeDisplay').textContent = 'Select a time';
                        document.getElementById('selected-time').value = '';
                        delete document.getElementById('selected-time').dataset.key;
                    }
                }
            }
        }
        
        // ==================== FIXED BOOKING SUBMISSION WITH REAL-TIME SYNC ====================
        async function submitBooking() {
            console.log("üì§ Submitting booking with real-time sync...");
            
            let name, email, contactInfo;
            
            if (contactMethod === 'phone') {
                name = document.getElementById('full-name').value.trim();
                email = document.getElementById('email').value.trim();
                contactInfo = document.getElementById('phone').value.trim();
            } else {
                name = document.getElementById('snapchat-name').value.trim();
                email = document.getElementById('snapchat-email').value.trim();
                contactInfo = document.getElementById('snapchat-username').value.trim();
                const phone = document.getElementById('snapchat-phone').value.trim();
                if (phone) contactInfo += ` (Phone: ${phone})`;
            }
            
            const timeKey = document.getElementById('selected-time').dataset.key;
            const date = document.getElementById('call-date').value;
            const timeDisplay = document.getElementById('selected-time').value;
            
            // Check again if slot is still available (race condition)
            if (realTimeBookedSlots[timeKey]) {
                alert('This time slot was just booked by someone else. Please select another time.');
                generateTimeSlots();
                return;
            }
            
            const registration = {
                id: Date.now(),
                plan: selectedPlan,
                price: selectedPlanPrice,
                contactMethod: contactMethod,
                name: name,
                email: email,
                contactInfo: contactInfo,
                country: document.getElementById('country').value,
                date: date,
                time: timeDisplay,
                timeKey: timeKey,
                timezone: document.getElementById('timezone').value || 'GMT',
                experience: document.getElementById('experience').value,
                goals: document.getElementById('goals').value.trim(),
                questions: document.getElementById('questions').value.trim(),
                timestamp: new Date().toISOString(),
                ip: await getClientIP(),
                userAgent: navigator.userAgent
            };
            
            try {
                // Save to Firestore
                const bookingRef = await db.collection('bookings').add(registration);
                
                // Mark time slot as booked in Firestore
                await db.collection('bookedSlots').doc(timeKey).set({
                    timeKey: timeKey,
                    date: date,
                    time: timeDisplay,
                    bookedAt: new Date().toISOString(),
                    bookingId: bookingRef.id,
                    bookedBy: email
                });
                
                console.log('‚úÖ Saved to Firebase with ID:', bookingRef.id);
                
                // Update local cache
                realTimeBookedSlots[timeKey] = true;
                
                // Show confirmation
                document.getElementById('appointment-date-display').textContent = formatDate(date);
                document.getElementById('appointment-time-display').textContent = timeDisplay + ' GMT';
                
                closeBookingModal();
                
                setTimeout(function() {
                    document.getElementById('appointmentConfirmationModal').classList.add('active');
                    document.body.style.overflow = 'hidden';
                }, 100);
                
                // Send notification (optional)
                sendBookingNotification(registration);
                
            } catch (error) {
                console.error('‚ùå Booking failed:', error);
                alert('Booking failed. Please try again or contact support.');
            }
        }
        
        // ==================== HIDDEN ADMIN ACCESS ====================
        function setupHiddenAdminAccess() {
            // Hidden key sequence: Press S Y N C E D in sequence
            let keySequence = [];
            const secretCode = ['s','y','n','c','e','d'];
            
            document.addEventListener('keydown', function(e) {
                // Only track letters
                if (e.key.length === 1 && e.key.match(/[a-z]/i)) {
                    keySequence.push(e.key.toLowerCase());
                    
                    // Keep only last 6 keys
                    if (keySequence.length > secretCode.length) {
                        keySequence.shift();
                    }
                    
                    // Check if sequence matches
                    if (keySequence.join('') === secretCode.join('')) {
                        showAdminLogin();
                        keySequence = []; // Reset
                    }
                }
            });
        }
        
        function showAdminLogin() {
            const password = prompt("Enter admin password:");
            if (password === "s2ps@S2PS@") {
                // Create session and redirect
                const sessionData = {
                    password: password,
                    start: Date.now(),
                    expires: Date.now() + (30 * 60 * 1000) // 30 minutes
                };
                localStorage.setItem('admin_session', JSON.stringify(sessionData));
                window.location.href = 'admin.html';
            } else {
                alert('Incorrect password');
            }
        }
        
        // ==================== HELPER FUNCTIONS ====================
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'Unknown';
            }
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        
        function sendBookingNotification(registration) {
            // Optional: Add webhook or email notification here
            console.log('üìß New booking:', registration);
        }
        
        // ==================== INITIALIZE ALL COMPONENTS ====================
        function initializeAll() {
            console.log("üîÑ Initializing all components...");
            
            // Initialize FAQ
            initializeFAQ();
            
            // Initialize booking buttons
            initializeBookingButtons();
            
            // Initialize smooth scrolling
            initializeSmoothScrolling();
            
            // Set up date change listener
            const dateInput = document.getElementById('call-date');
            if (dateInput) {
                dateInput.addEventListener('change', function() {
                    generateTimeSlots();
                });
            }
            
            // Start real-time sync
            initializeRealtimeSync();
            
            // Setup modal close listeners
            setupModalCloseListeners();
            
            console.log("‚úÖ All components initialized!");
        }
        
        // ==================== YOUR EXISTING FUNCTIONS (ADAPTED) ====================
        // [KEEP ALL YOUR EXISTING FUNCTIONS BUT REMOVE LOCAL STORAGE FOR SLOTS]
        // openBookingModal, closeBookingModal, selectContactMethod, etc.
        // Remove any localStorage.setItem for booked slots
        
        // Initialize FAQ function (from your code)
        function initializeFAQ() {
            const faqItems = document.querySelectorAll('.faq-item');
            
            faqItems.forEach(item => {
                const question = item.querySelector('.faq-question');
                const answer = item.querySelector('.faq-answer');
                const icon = question.querySelector('i');
                
                // Initialize all answers as closed
                if (answer) {
                    answer.style.maxHeight = '0';
                    answer.style.overflow = 'hidden';
                }
                
                // Add click event
                question.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const isActive = item.classList.contains('active');
                    
                    // Close all other FAQ items
                    faqItems.forEach(otherItem => {
                        if (otherItem !== item) {
                            otherItem.classList.remove('active');
                            const otherAnswer = otherItem.querySelector('.faq-answer');
                            const otherIcon = otherItem.querySelector('.faq-question i');
                            
                            if (otherAnswer) {
                                otherAnswer.style.maxHeight = '0';
                                otherAnswer.style.padding = '0 20px';
                            }
                            
                            if (otherIcon) {
                                otherIcon.className = 'fas fa-chevron-down';
                            }
                        }
                    });
                    
                    // Toggle current item
                    if (!isActive) {
                        item.classList.add('active');
                        if (answer) {
                            answer.style.maxHeight = answer.scrollHeight + 'px';
                            answer.style.padding = '20px';
                        }
                        if (icon) {
                            icon.className = 'fas fa-chevron-up';
                        }
                    } else {
                        item.classList.remove('active');
                        if (answer) {
                            answer.style.maxHeight = '0';
                            answer.style.padding = '0 20px';
                        }
                        if (icon) {
                            icon.className = 'fas fa-chevron-down';
                        }
                    }
                });
            });
        }
        
        // Initialize booking buttons function
        function initializeBookingButtons() {
            const bookingButtons = document.querySelectorAll('.book-call-btn');
            
            bookingButtons.forEach(button => {
                // Remove and re-add to ensure clean state
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
            });
            
            // Re-select and add event listeners
            document.querySelectorAll('.book-call-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const plan = this.getAttribute('data-plan');
                    const price = this.getAttribute('data-price');
                    
                    openBookingModal(plan, parseInt(price));
                });
            });
        }
        
        // Your other functions remain the same but use realTimeBookedSlots instead of localStorage
        // selectTime, toggleTimeDropdown, validateStep1, validateStep2, etc.
    </script>
</body>
</html>
